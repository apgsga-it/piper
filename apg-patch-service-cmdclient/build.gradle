plugins {
  	id 'groovy'
   id 'application'
	id "com.github.johnrengelman.shadow" version "2.0.2"
}
apply plugin: 'groovy'
apply plugin: "com.github.johnrengelman.shadow"

sourceCompatibility = 1.8
targetCompatibility = 1.8

mainClassName = 'pli'
def repoTarget= version.endsWith("SNAPSHOT") ? "snapshots" : "releases"
jar {
	baseName = "apg-patch-cli"
} 

shadowJar {
	baseName = "apg-patch-cli"
	classifier = null
   	version = null
}


dependencies {
	// Application dependencies
	compile project(':apg-patch-service-common')
	compile group: 'org.codehaus.groovy' , name: 'groovy-all', version: '2.4.1'
	compile 'org.codehaus.groovy:groovy-backports-compat23:2.4.5'
	compile group: 'com.fasterxml.jackson.core', name: 'jackson-annotations', version: '2.8.4'
	compile group: 'com.fasterxml.jackson.core', name: 'jackson-core', version: '2.8.4'
	compile group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: '2.8.4'
	runtime group: 'commons-cli' , name: 'commons-cli', version: '1.4'
	testCompile project(':apg-patch-service-server')
	testCompile group: 'org.springframework', name: 'spring-test'
	testCompile group: 'org.springframework.boot', name: 'spring-boot-starter-test'	
	testCompile 'org.spockframework:spock-spring:1.1-groovy-2.4'
	testCompile 'cglib:cglib-nodep:3.2.2' // for stubbing of classes

}

sourceSets {
  test {
    resources {
      srcDir 'src/test/groovy'
      include '**/*.properties'
    }
  }
}

task pkgAsGTar(type: Tar) {
	from "$project.buildDir/apg-patch-cli"
	archiveName = "apg-patch-cli.tar.gz"
	compression = Compression.GZIP
}

task copyLib( type: Copy ) {
	into "$project.buildDir/apg-patch-cli"
	from shadowJar
	fileMode 0755
	// In lib we only want jars files to go in lib folder (no dll, exe, bat, etc...)
	include "*.jar"
}

task copyResources (type: Copy) {
	from sourceSets.main.resources
	into "$project.buildDir/apg-patch-cli"
	fileMode 0755
}


publishing {
	publications {
		cligtar(MavenPublication) {
			artifact source: pkgAsGTar, extension: 'tar.gz'
			
			artifactId = 'apg-patch-cli'



			pom.withXml { asNode().appendNode('description', 'From versions.properties generated dependency management pom.xml') }
		}
	}
	repositories {
		maven {
			name ='deployRepo'
			url  "${mavenRepoBaseUrl}/${repoTarget}/"
			credentials {
				username = repoUser
				password = repoPassword
			}
		}

	}

}

assemble { dependsOn  copyResources, copyLib,pkgAsGTar}
build {dependsOn assemble }
publish {dependsOn build }
publishToMavenLocal {dependsOn build }


